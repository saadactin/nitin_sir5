<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sync Dashboard - SQL Sync</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: { DEFAULT: "#1E40AF", hover: "#1D4ED8" },
            success: "#198754",
            successDark: "#157347",
            danger: "#DC3545",
            warning: "#FFC107",
            backgroundLight: "#F8FAFC",
            backgroundDark: "#0F172A",
            surfaceLight: "#FFFFFF",
            surfaceDark: "#1E293B",
            textLight: "#0F172A",
            textDark: "#E2E8F0",
            subtextLight: "#64748B",
            subtextDark: "#94A3B8",
            borderLight: "#E2E8F0",
            borderDark: "#334155",
          },
          fontFamily: { display: ["Inter", "sans-serif"] }
        }
      }
    };
  </script>
  <style>
    .material-icons { font-size: 20px; vertical-align: middle; }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-text-light dark:text-text-dark">

<div class="flex h-screen">
  <!-- Sidebar -->
  {% include 'sidebar.html' %}

  <!-- Main Content -->
  <main class="flex-1 overflow-y-auto ml-64 p-8 space-y-6">
    <div class="flex justify-between items-center">
      <h2 class="text-3xl font-bold flex items-center gap-2">
        <span class="material-icons">dashboard</span> Sync Dashboard
      </h2>
    </div>

    <!-- Last Sync Details -->
    <div class="bg-surface-light dark:bg-surface-dark rounded-lg shadow border border-border-light dark:border-border-dark p-6">
      <h3 class="text-xl font-semibold mb-4 text-primary">Last Sync Details</h3>
      <div id="last-sync" class="space-y-2">
        {% if last_detail %}
          <p><strong>Server:</strong> {{ last_detail.server }}</p>
          <p><strong>Time:</strong> {{ last_detail.time }}</p>
          <p><strong>Status:</strong>
            {% if last_detail.status == "success" %}
              <span class="bg-success text-white px-2 py-1 rounded">Success</span>
            {% else %}
              <span class="bg-danger text-white px-2 py-1 rounded">Failed</span>
            {% endif %}
          </p>
          <p><strong>Details:</strong> {{ last_detail.details }}</p>
        {% else %}
          <div class="bg-blue-100 text-blue-800 p-3 rounded">No syncs recorded yet.</div>
        {% endif %}
      </div>
    </div>

    <!-- Last 10 Sync History -->
    <div class="bg-surface-light dark:bg-surface-dark rounded-lg shadow border border-border-light dark:border-border-dark p-6">
      <h3 class="text-xl font-semibold mb-4 text-primary">Last 10 Syncs</h3>
      <div id="sync-history" class="overflow-x-auto">
        {% if last_10 and last_10|length > 0 %}
          <table class="min-w-full table-auto border border-border-light dark:border-border-dark">
            <thead class="bg-gray-100 dark:bg-gray-700">
              <tr>
                <th class="px-4 py-2 border border-border-light dark:border-border-dark">Server</th>
                <th class="px-4 py-2 border border-border-light dark:border-border-dark">Time</th>
                <th class="px-4 py-2 border border-border-light dark:border-border-dark">Status</th>
                <th class="px-4 py-2 border border-border-light dark:border-border-dark">Details</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in last_10 %}
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-800">
                <td class="px-4 py-2 border border-border-light dark:border-border-dark">{{ entry.server }}</td>
                <td class="px-4 py-2 border border-border-light dark:border-border-dark">{{ entry.time }}</td>
                <td class="px-4 py-2 border border-border-light dark:border-border-dark">
                  {% if entry.status == "success" %}
                    <span class="bg-success text-white px-2 py-1 rounded">Success</span>
                  {% else %}
                    <span class="bg-danger text-white px-2 py-1 rounded">Failed</span>
                  {% endif %}
                </td>
                <td class="px-4 py-2 border border-border-light dark:border-border-dark">{{ entry.details }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="bg-blue-100 text-blue-800 p-3 rounded">No sync history found.</div>
        {% endif %}
      </div>
    </div>
  </main>
</div>

<script>
async function refreshDashboard() {
    try {
        const res = await fetch("/dashboard/data");
        const data = await res.json();

        // Update last sync details
        const last = data.last_detail;
        if (last) {
            document.getElementById("last-sync").innerHTML = `
                <p><strong>Server:</strong> ${last.server}</p>
                <p><strong>Time:</strong> ${last.time}</p>
                <p><strong>Status:</strong>
                    ${last.status === "success"
                        ? '<span class="bg-success text-white px-2 py-1 rounded">Success</span>'
                        : '<span class="bg-danger text-white px-2 py-1 rounded">Failed</span>'}
                </p>
                <p><strong>Details:</strong> ${last.details}</p>`;
        } else {
            document.getElementById("last-sync").innerHTML =
                '<div class="bg-blue-100 text-blue-800 p-3 rounded">No syncs recorded yet.</div>';
        }

        // Update sync history
        const historyDiv = document.getElementById("sync-history");
        if (data.last_10.length > 0) {
            let table = `<table class="min-w-full table-auto border border-border-light dark:border-border-dark">
                <thead class="bg-gray-100 dark:bg-gray-700">
                    <tr>
                        <th class="px-4 py-2 border border-border-light dark:border-border-dark">Server</th>
                        <th class="px-4 py-2 border border-border-light dark:border-border-dark">Time</th>
                        <th class="px-4 py-2 border border-border-light dark:border-border-dark">Status</th>
                        <th class="px-4 py-2 border border-border-light dark:border-border-dark">Details</th>
                    </tr>
                </thead>
                <tbody>`;

            data.last_10.forEach(entry => {
                table += `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-800">
                        <td class="px-4 py-2 border border-border-light dark:border-border-dark">${entry.server}</td>
                        <td class="px-4 py-2 border border-border-light dark:border-border-dark">${entry.time}</td>
                        <td class="px-4 py-2 border border-border-light dark:border-border-dark">
                            ${entry.status === "success"
                                ? '<span class="bg-success text-white px-2 py-1 rounded">Success</span>'
                                : '<span class="bg-danger text-white px-2 py-1 rounded">Failed</span>'}
                        </td>
                        <td class="px-4 py-2 border border-border-light dark:border-border-dark">${entry.details}</td>
                    </tr>`;
            });

            table += "</tbody></table>";
            historyDiv.innerHTML = table;
        } else {
            historyDiv.innerHTML = '<div class="bg-blue-100 text-blue-800 p-3 rounded">No sync history found.</div>';
        }
    } catch (err) {
        console.error("Failed to refresh dashboard:", err);
    }
}

// Auto-refresh every 5 seconds
setInterval(refreshDashboard, 5000);
</script>

</body>
</html>
